import type { Questionnaire, QuestionnaireResponse } from "@/types/questionnaire"
import { 
  saveQuestionnaireResponse as saveQuestionnaireResponseToFirebase,
  getResponsesByQuestionnaireId as getResponsesByQuestionnaireIdFromFirebase,
  getQuestionnaireResponses as getQuestionnaireResponsesFromFirebase,
} from "./firebase-questionnaires"
import { getAllQuestionnaires, getQuestionnaireById as getQuestionnaireFromRegistry } from "@/public/questionnaires"

// Generate questionnaires dynamically with current KML data
function generateDefaultQuestionnaires(): Questionnaire[] {
  return getAllQuestionnaires()
}

// Dynamic questionnaire getter
export function getDefaultQuestionnaires(): Questionnaire[] {
  return generateDefaultQuestionnaires()
}

// Export the constant for backward compatibility  
export const DEFAULT_QUESTIONNAIRES = generateDefaultQuestionnaires()

// Simple local questionnaire functions - no Firebase dependency
export function getQuestionnaires(): Questionnaire[] {
  return DEFAULT_QUESTIONNAIRES
}

export function getQuestionnaireById(id: string): Questionnaire | null {
  const questionnaire = getQuestionnaireFromRegistry(id)
  return questionnaire ?? null
}

export async function saveQuestionnaireResponse(response: Omit<QuestionnaireResponse, 'id' | 'submittedAt'>): Promise<string> {
  try {
    return await saveQuestionnaireResponseToFirebase(response)
  } catch (error) {
    console.error('Error saving questionnaire response to Firebase:', error)
    throw error
  }
}

export async function getQuestionnaireResponses(): Promise<QuestionnaireResponse[]> {
  try {
    return await getQuestionnaireResponsesFromFirebase()
  } catch (error) {
    console.error('Error fetching questionnaire responses from Firebase:', error)
    return []
  }
}

export async function getResponsesByQuestionnaireId(questionnaireId: string): Promise<QuestionnaireResponse[]> {
  try {
    return await getResponsesByQuestionnaireIdFromFirebase(questionnaireId)
  } catch (error) {
    console.error('Error fetching responses by questionnaire ID from Firebase:', error)
    return []
  }
}

export function validateQuestionnaireJSON(json: string): {
    organize: "交通部運輸研究所",
    createdAt: "2025-07-03T00:00:00+08:00",
    updatedAt: "2025-07-03T00:00:00+08:00",
    // Route tracking configuration
    routeTracking: {
      enabled: true,
      routeSelectionQuestionId: "recent-route",
      trackSubmissionsByRoute: true
    },
    // Validation rules for route submissions
    validationRules: [
      {
        type: 'route_submission_limit',
        config: {
          maxSubmissionsPerRoute: 1,
          routeSelectionQuestionId: "recent-route"
        },
        enforcement: 'block',
        errorMessage: '您已經填寫過此路線的問卷，每條路線只能填寫一次',
        isActive: true
      }
    ],
    sections: [
      {
        id: "basic-info",
        title: "受訪者基本資料",
        questions: [
          {
            id: "gender",
            type: "radio-text",
            label: "您的性別",
            required: true,
            options: [{
              label: "男",
              value: "男"
            }, {
              label: "女",
              value: "女"
            }, {
              label: "其他",
              value: "其他",
              hasTextInput: true,
              textLabel: "性別描述",
              textMinLength: 2,
              textMaxLength: 20,
            }],
          },
          {
            id: "age",
            type: "radio",
            label: "您的年齡",
            required: true,
            options: ["12歲以下", "13~20歲", "21~30歲", "31~40歲", "41~50歲", "51~60歲", "61~64歲", "65歲以上"],
          },
          {
            id: "city",
            type: "select",
            label: "您居住的縣市",
            required: true,
            options: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
              "外國",
            ],
          },
        ],
      },
      {
        id: "route-usage",
        title: "環島自行車路線騎乘情形",
        questions: [
          {
            id: "recent-route",
            type: "map",
            label: "請選擇一年內曾騎乘過的環島自行車路線",
            required: true,
            options: [], // Empty options array for map type
            defaultCenter: [23.8, 121.0],
            defaultZoom: 7,
            showLayerControl: true,
            kmlFiles: getKMLFilesByCategory('round-island').map((kml: any) => ({
              id: kml.id,
              name: kml.name,
              url: kml.url,
              visible: kml.visible,
              color: kml.color
            }))
          },
          {
            id: "recent-route-date",
            type: "time",
            label: "最近一次騎乘該路線的時間",
            timeFormat: "YYYY-MM",
            required: true,
            minDate: "2023-01",
            maxDate: "2025-09",
          },
          {
            id: "route-purpose",
            type: "select-text",
            label: "該次旅程的目的",
            required: true,
            options: ["一鼓作氣環島", "分段環島", "休閒旅遊", "運動健身", "通勤通學", "其他"],
            textLabel: "其他目的",
            textPlaceholder: "請描述您的旅程目的",
            textMinLength: 2,
            textMaxLength: 50,
          },
          {
            id: "bike-source",
            type: "select-text",
            label: "自行車來源",
            required: true,
            options: ["自己的車", "旅行社提供", "飯店提供", "租賃", "親友借用", "其他"],
            textLabel: "其他來源",
            textPlaceholder: "請描述自行車來源",
            textMinLength: 2,
            textMaxLength: 50,
          },
          {
            id: "other-transport",
            type: "checkbox",
            label: "還使用哪些交通工具（可複選）",
            required: true,
            options: [
              "遊覽車",
              "火車",
              "汽車",
              "機車",
              "步行",
              "客運/公車",
              "計程車",
              "飛機",
              "船",
              "捷運",
              "高鐵",
              "未使用其他交通工具",
            ]
          },
        ],
      },
      {
        id: "continuity",
        title: "一、連續性",
        description: "請就您當次旅程體驗，填答下列各項設施及服務的滿意度：",
        questions: [
          {
            id: "route-sign",
            type: "radio",
            label: "本路線尋路/導引標誌標線",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "route-bridge",
            type: "radio",
            label: "橋梁或地下道的自行車騎乘動線",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "route-barrier",
            type: "radio",
            label: "本路線車阻設置形式及位置",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "route-continuity",
            type: "radio",
            label: "本路線整體騎乘動線的連續性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "continuity-issue",
            type: "region-long-answer",
            label: "您對騎乘動線感到連續性不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "連續性不佳的原因",
          },
        ],
      },
      {
        id: "safety",
        title: "二、安全性",
        questions: [
          {
            id: "road-flatness",
            type: "radio",
            label: "行經路線的車道鋪面平整度",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "side-protection",
            type: "radio",
            label: "行經路線的車道路側防護設施(如：護欄、綠籬)",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "drainage-protection",
            type: "radio",
            label: "行經路線的車道路側排水溝蓋防護設施安全性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "riding-space",
            type: "radio",
            label: "行經路線的車道騎乘空間(如：寬度、型式)",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "intersection-safety",
            type: "radio",
            label: "穿越路口的安全性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "bridge-expansion-joint",
            type: "radio",
            label: "行經路線橋梁伸縮縫設施的安全性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "lighting",
            type: "radio",
            label: "行經隧道或陰暗處的照明設備",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "overall-safety",
            type: "radio",
            label: "本路線整體騎乘空間的安全性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "safety-issue",
            type: "region-long-answer",
            label: "您對騎乘路線感到安全性不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "安全性不佳的原因",
          },
        ],
      },
      {
        id: "convenience",
        title: "三、便利性",
        questions: [
          {
            id: "supply-guide",
            type: "radio",
            label: "補給站導引指示及里程資訊",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "supply-density",
            type: "radio",
            label: "補給站設置密度",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "supply-service",
            type: "radio",
            label: "補給站服務項目",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "repair-post-location",
            type: "radio",
            label: "維修椿設置位置",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "repair-tools",
            type: "radio",
            label: "維修椿提供之維修工具",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "service-info",
            type: "radio",
            label: "沿途自行車路線服務資訊提供的滿意度",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "overall-convenience",
            type: "radio",
            label: "本路線沿途自行車服務設施的便利性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "convenience-issue",
            type: "region-long-answer",
            label: "您對沿途自行車服務設施的便利性感到不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "便利性不佳的原因",
          },
        ],
      },
      {
        id: "environment",
        title: "四、騎乘環境",
        questions: [
          {
            id: "environment-air-quality",
            type: "radio",
            label: "沿線的空氣品質",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "environment-shade-ratio",
            type: "radio",
            label: "沿線的綠蔭比例",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "environment-comfort",
            type: "radio",
            label: "本路線整體騎乘環境之舒適性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "environment-issue",
            type: "region-long-answer",
            label: "您對騎乘環境感到舒適性不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "舒適性不佳的原因",
          },
        ],
      },
      {
        id: "overall-satisfaction-gender",
        title: "五、整體體驗與性別友善",
        questions: [
          {
            id: "overall-satisfaction",
            type: "radio",
            label: "您對於本路線的整體騎乘體驗滿意程度為？",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "overall-satisfaction-reason",
            type: "radio-text",
            label: "您認為本路線的各項設施，是否存在性別差異而導致使用不便之處？",
            required: true,
            options: [
              {
                value: "無",
                label: "無",
              },
              {
                value: "有",
                label: "有",
                hasTextInput: true,
                textLabel: "設施描述",
                textPlaceholder: "請簡單說明是何種設施...",
                textMinLength: 5,
                textMaxLength: 300,
              },
            ],
          },
          {
            id: "overall-gender-advise",
            type: "textarea",
            label: "從性別差異的角度來看，您認為在推廣自行車活動方面可以增添哪些服務或改進建議：",
            required: true,
          },
        ],
      },
      {
        id: "train-service-a",
        title: "六、兩鐵列車服務A",
        questions: [
          {
            id: "train-used",
            type: "radio",
            label: "請問您是否曾使用「人車同行」的兩鐵列車服務？",
            required: true,
            options: ["是", "否"],
          },
        ],
      },
      {
        id: "train-service-b",
        title: "六、兩鐵列車服務B",
        questions: [
          {
            id: "train-unused-reason",
            type: "checkbox-text",
            label: "請問您未曾使用兩鐵列車服務的原因為何？",
            required: true,
            options: ["訂不到票", "不知有此服務", "班次不好搭配", "沒有需求", "其他"],
            textLabel: "其他原因",
            textPlaceholder: "請說明其他未使用的原因",
            textMinLength: 3,
            textMaxLength: 100,
            conditional: {
              dependsOn: "train-used",
              showWhen: "否",
            },
          },
        ],
      },
      {
        id: "train-service-c",
        title: "六、兩鐵列車服務C",
        questions: [
          {
            id: "train-mode",
            type: "radio",
            label: "您最常使用何種乘車方式？",
            required: true,
            options: ["人車同行", "自行車託運", "兩鐵專車"],
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-service-satisfaction",
            type: "matrix",
            label: "請針對以下兩鐵列車提供的服務項目，填答您認知的重要性及使用的滿意度：",
            required: true,
            options: [
              "兩鐵環保列車各班次自行車剩餘空位查詢",
              "購票方式",
              "網路購票操作介面",
              "App購票操作介面",
              "兩鐵班次資訊查詢",
              "自行車可進出車站資訊",
              "自行車進出月台動線指引",
              "車站自行車牽引道",
              "車站電梯",
              "對號車廂內，自行車停放空間",
              "非對號車廂內，自行車停放空間",
            ],
            scale: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用經驗"],
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-service-improvement",
            type: "region-long-answer",
            label: "您對兩鐵列車所提供之上述服務感到不滿意之地點及原因為何？（非必填）",
            regions: [
              "基隆車站",
              "台北車站",
              "板橋車站",
              "桃園車站",
              "新竹車站",
              "苗栗車站",
              "台中車站",
              "彰化車站",
              "雲林車站",
              "嘉義車站",
              "台南車站",
              "高雄車站",
              "屏東車站",
              "台東車站",
              "花蓮車站",
              "宜蘭車站",
              "其他車站",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "設施名稱",
            locationLabel: "待改善設施",
            reasonPlaceholder: "不滿意的原因",
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-increase-schedule",
            type: "train-schedule-request",
            label: "您認為兩鐵列車之服務班次，是否有需要增加？",
            required: true,
            options: ["無需增加", "需要增加班次"],
            showScheduleWhen: "需要增加班次",
            minBlocks: 1,
            maxBlocks: 3,
            startStationLabel: "站別（起點）",
            endStationLabel: "站別（迄點）",
            scheduleLabel: "日別",
            startStationPlaceholder: "請輸入起點站名",
            endStationPlaceholder: "請輸入終點站名",
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-willingness",
            type: "radio-text",
            label: "前述服務加強改善後，是否會提升您使用兩鐵列車的意願？",
            required: true,
            options: [
              {
                value: "是",
                label: "是",
              },
              {
                value: "不一定",
                label: "不一定",
              },
              {
                value: "否",
                label: "否",
                hasTextInput: true,
                textLabel: "請說明原因",
                textPlaceholder: "請簡單說明原因...",
                textMinLength: 5,
                textMaxLength: 300,
              },
            ],
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-station-friendliness",
            type: "textarea",
            label:
              "有愈來愈多的青年學子及多元弱勢族群（如：高齡者、身心障礙人士）以騎乘自行車環島當作人生挑戰，您認為做為自行車補給站的臺鐵車站有哪些可再增加或提升的自行車友善設施？",
            required: true,
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
        ],
      },
    ],
  },
  {
    id: "diverse-cycling-survey-2025",
    title: "「多元自行車路線」使用情形及滿意度問卷",
    description:
      "本問卷目的在了解您曾經騎乘或本次騎乘「多元自行車路線」的感受及意見，做為後續路線規劃及改善參考，謝謝！",
    version: "1.0.0",
    organize: "交通部運輸研究所",
    createdAt: "2025-07-03T00:00:00+08:00",
    updatedAt: "2025-07-03T00:00:00+08:00",
    // Route tracking configuration
    routeTracking: {
      enabled: true,
      routeSelectionQuestionId: "recent-route",
      trackSubmissionsByRoute: true
    },
    // Validation rules for route submissions
    validationRules: [
      {
        type: 'route_submission_limit',
        config: {
          maxSubmissionsPerRoute: 1,
          routeSelectionQuestionId: "recent-route"
        },
        enforcement: 'block', // Allow but warn for diverse routes
        errorMessage: '您已經填寫過此路線的問卷',
        warningMessage: '您已經填寫過此路線，確定要再次填寫嗎？',
        isActive: true
      }
    ],
    sections: [
      {
        id: "basic-info",
        title: "受訪者基本資料",
        questions: [
          {
            id: "recent-route",
            type: "map",
            label: "請選擇一條您近一年內曾騎乘過的環島自行車路線",
            required: true,
            options: [], // Empty options array for map type
            defaultCenter: [23.8, 121.0],
            defaultZoom: 7,
            showLayerControl: true,
            kmlFiles: getKMLFilesByCategory('diverse').map((kml: any) => ({
              id: kml.id,
              name: kml.name,
              url: kml.url,
              visible: kml.visible,
              color: kml.color
            }))
          },
          {
            id: "recent-route-date",
            type: "time",
            label: "最近一次騎乘該路線的時間",
            timeFormat: "YYYY-MM",
            required: true,
            minDate: "2023-01",
            maxDate: "2025-09",
          },
          {
            id: "ride-before",
            type: "radio-number",
            label: "請問您先前是否騎乘過本路線？",
            required: true,
            options: [
              {
                value: "無",
                label: "無",
              },
              {
                value: "yes",
                label: "有",
                hasNumberInput: true,
                numberLabel: "騎乘次數",
                numberMin: 1,
                numberMax: 100,
              },
            ],
          },
          {
            id: "ride-purpose",
            type: "select-text",
            label: "請問您該次旅程的目的為何？",
            required: true,
            options: ["休閒旅遊", "旅行社提供", "運動健身", "通勤通學", "其他"],
            textLabel: "其他目的",
            textPlaceholder: "請描述您的旅程目的",
            textMinLength: 2,
            textMaxLength: 50,
          },
          {
            id: "ride-source",
            type: "select-text",
            label: "請問您該次所騎乘的自行車來源為何？",
            required: true,
            options: [
              "自己的車",
              "旅行社提供",
              "飯店提供",
              "租賃",
              "親友借用",
              "其他",
            ],
            textLabel: "其他來源",
            textPlaceholder: "請描述自行車來源",
            textMinLength: 2,
            textMaxLength: 50,
          },
          {
            id: "ride-party",
            type: "radio-number",
            label: "請問您該次騎乘同行成員為何？",
            required: true,
            options: [
              {
                value: "獨自騎乘",
                label: "獨自騎乘"
              },
              {
                value: "親友",
                label: "親友",
                hasNumberInput: true,
                numberLabel: "人數",
                numberPlaceholder: "人數為....",
                numberMin: 1,
                numberMax: 100
              },
              {
                value: "旅行團",
                label: "旅行團",
                hasNumberInput: true,
                numberLabel: "人數",
                numberPlaceholder: "人數為....",
                numberMin: 1,
                numberMax: 100
              },
              {
                value: "參與活動",
                label: "參與活動",
                hasNumberInput: true,
                numberLabel: "人數",
                numberPlaceholder: "人數為....",
                numberMin: 1,
                numberMax: 100
              },
              {
                value: "其他",
                label: "其他",
                hasTextInput: true,
                textLabel: "其他同行成員",
                textPlaceholder: "請描述同行成員",
                textMinLength: 2,
                textMaxLength: 30
              }
            ]
          },
          {
            id: "other-transport",
            type: "checkbox",
            label: "請問您該次旅程除了自行車，還使用哪些交通工具？（可複選）",
            required: true,
            options: [
              "遊覽車",
              "火車",
              "汽車",
              "機車",
              "步行",
              "客運/公車",
              "計程車",
              "飛機",
              "船",
              "捷運",
              "高鐵",
              "未使用其他交通工具",
            ],
          }, 
        ],
      },
      {
        id: "continuity",
        title: "一、連續性",
        description: "請就您當次旅程體驗，填答下列各項設施及服務的滿意度：",
        questions: [
          {
            id: "route-sign",
            type: "radio",
            label: "本路線尋路/導引標誌標線",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "route-bridge",
            type: "radio",
            label: "橋梁或地下道的自行車騎乘動線",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "route-barrier",
            type: "radio",
            label: "本路線車阻設置形式及位置",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "route-continuity",
            type: "radio",
            label: "本路線整體騎乘動線的連續性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "continuity-issue",
            type: "region-long-answer",
            label: "您對騎乘動線感到連續性不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "連續性不佳的原因",
          },
        ],
      },
      {
        id: "safety",
        title: "二、安全性",
        questions: [
          {
            id: "road-flatness",
            type: "radio",
            label: "行經路線的車道鋪面平整度",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "side-protection",
            type: "radio",
            label: "行經路線的車道路側防護設施(如：護欄、綠籬)",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "drainage-protection",
            type: "radio",
            label: "行經路線的車道路側排水溝蓋防護設施安全性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "riding-space",
            type: "radio",
            label: "行經路線的車道騎乘空間(如：寬度、型式)",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "intersection-safety",
            type: "radio",
            label: "穿越路口的安全性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "bridge-expansion-joint",
            type: "radio",
            label: "行經路線橋梁伸縮縫設施的安全性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "lighting",
            type: "radio",
            label: "行經隧道或陰暗處的照明設備",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "overall-safety",
            type: "radio",
            label: "本路線整體騎乘空間的安全性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "safety-issue",
            type: "region-long-answer",
            label: "您對騎乘路線感到安全性不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "安全性不佳的原因",
          },
        ],
      },
      {
        id: "convenience",
        title: "三、便利性",
        questions: [
          {
            id: "supply-guide",
            type: "radio",
            label: "自行車租賃便利性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "supply-density",
            type: "radio",
            label: "補給站設置密度",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "supply-service",
            type: "radio",
            label: "補給站服務項目",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "repair-post-location",
            type: "radio",
            label: "維修椿設置位置",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "repair-tools",
            type: "radio",
            label: "維修椿提供之維修工具",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "service-info",
            type: "radio",
            label: "沿途自行車路線服務資訊提供的滿意度",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "overall-convenience",
            type: "radio",
            label: "本路線沿途自行車服務設施的便利性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "convenience-issue",
            type: "region-long-answer",
            label: "您對沿途自行車服務設施的便利性感到不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "便利性不佳的原因",
          },
        ],
      },
      {
        id: "richness",
        title: "四、豐富性",
        questions: [
          {
            id: "richness-scenery",
            type: "radio",
            label: "全線觀光景點的串聯方式",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "richness-culture",
            type: "radio",
            label: "觀光景點自行車服務設施",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意", "無使用本項目"],
          },
          {
            id: "richness-activity",
            type: "radio",
            label: "本路線遊程的豐富性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "environment-issue",
            type: "region-long-answer",
            label: "您對騎乘環境感到舒適性不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "舒適性不佳的原因",
          },
        ],
      },
      {
        id: "environment",
        title: "五、騎乘環境",
        questions: [
          {
            id: "environment-air-quality",
            type: "radio",
            label: "沿線的空氣品質",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "environment-shade-ratio",
            type: "radio",
            label: "沿線的綠蔭比例",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "environment-comfort",
            type: "radio",
            label: "本路線整體騎乘環境之舒適性",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "environment-issue",
            type: "region-long-answer",
            label: "您對騎乘環境感到舒適性不佳的路段或地點及其原因為何？（非必填）",
            regions: [
              "新北市",
              "宜蘭縣",
              "花蓮縣",
              "臺東縣",
              "基隆市",
              "臺北市",
              "桃園市",
              "苗栗縣",
              "新竹縣",
              "新竹市",
              "臺中市",
              "彰化縣",
              "雲林縣",
              "南投縣",
              "嘉義縣",
              "嘉義市",
              "臺南市",
              "高雄市",
              "屏東縣",
              "澎湖縣",
              "金門縣",
              "連江縣",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "路段或地點",
            reasonPlaceholder: "舒適性不佳的原因",
          },
        ],
      },
      {
        id: "overall-satisfaction",
        title: "整體體驗與性別友善",
        questions: [
          {
            id: "overall-satisfaction",
            type: "radio",
            label: "您對於本路線的整體騎乘體驗滿意程度為？",
            required: true,
            options: ["很不滿意", "不太滿意", "尚可", "還算滿意", "非常滿意"],
          },
          {
            id: "overall-satisfaction-reason",
            type: "radio-text",
            label: "您認為本路線的各項設施，是否存在性別差異而導致使用不便之處？",
            required: true,
            options: [
              {
                value: "無",
                label: "無",
              },
              {
                value: "有",
                label: "有",
                hasTextInput: true,
                textLabel: "設施描述",
                textPlaceholder: "請簡單說明是何種設施...",
                textMinLength: 5,
                textMaxLength: 300,
              },
            ],
          },
          {
            id: "overall-gender-advise",
            type: "textarea",
            label: "從性別差異的角度來看，您認為在推廣自行車活動方面可以增添哪些服務或改進建議：",
            required: true,
          },
        ],
      },
      {
        id: "train-service-a",
        title: "兩鐵列車服務A",
        questions: [
          {
            id: "train-used",
            type: "radio",
            label: "請問您是否曾使用「人車同行」的兩鐵列車服務？",
            required: true,
            options: ["是", "否"],
          },
        ],
      },
      {
        id: "train-service-b",
        title: "兩鐵列車服務B",
        questions: [
          {
            id: "train-unused-reason",
            type: "checkbox-text",
            label: "請問您未曾使用兩鐵列車服務的原因為何？",
            required: true,
            options: ["訂不到票", "不知有此服務", "班次不好搭配", "沒有需求", "其他"],
            textLabel: "其他原因",
            textPlaceholder: "請說明其他未使用的原因",
            textMinLength: 3,
            textMaxLength: 100,
            conditional: {
              dependsOn: "train-used",
              showWhen: "否",
            },
          },
        ],
      },
      {
        id: "train-service-c",
        title: "兩鐵列車服務C",
        questions: [
          {
            id: "train-mode",
            type: "radio",
            label: "您最常使用何種乘車方式？",
            required: true,
            options: ["人車同行", "自行車託運", "兩鐵專車"],
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-service-satisfaction",
            type: "matrix",
            label:
              "請針對以下兩鐵列車提供的服務項目，填答您認知的重要性及使用的滿意度：",
            required: true,
            options: [
              "兩鐵環保列車各班次自行車剩餘空位查詢",
              "購票方式",
              "網路購票操作介面",
              "App購票操作介面",
              "兩鐵班次資訊查詢",
              "自行車可進出車站資訊",
              "自行車進出月台動線指引",
              "車站自行車牽引道",
              "車站電梯",
              "對號車廂內，自行車停放空間",
              "非對號車廂內，自行車停放空間",
            ],
            scale: [
              "很不滿意",
              "不太滿意",
              "尚可",
              "還算滿意",
              "非常滿意",
              "無使用經驗",
            ],
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-service-improvement",
            type: "region-long-answer",
            label: "您對兩鐵列車所提供之上述服務感到不滿意之地點及原因為何？（非必填）",
            regions: [
              "基隆車站",
              "台北車站",
              "板橋車站",
              "桃園車站",
              "新竹車站",
              "苗栗車站",
              "台中車站",
              "彰化車站",
              "雲林車站",
              "嘉義車站",
              "台南車站",
              "高雄車站",
              "屏東車站",
              "台東車站",
              "花蓮車站",
              "宜蘭車站",
              "其他車站",
            ],
            minBlocks: 1,
            maxBlocks: 3,
            locationPlaceholder: "設施名稱",
            locationLabel: "待改善設施",
            reasonPlaceholder: "不滿意的原因",
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-increase-schedule",
            type: "train-schedule-request",
            label: "您認為兩鐵列車之服務班次，是否有需要增加？",
            required: true,
            options: ["無需增加", "需要增加班次"],
            showScheduleWhen: "需要增加班次",
            minBlocks: 1,
            maxBlocks: 3,
            startStationLabel: "站別（起點）",
            endStationLabel: "站別（迄點）",
            scheduleLabel: "日別",
            startStationPlaceholder: "請輸入起點站名",
            endStationPlaceholder: "請輸入終點站名",
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-willingness",
            type: "radio-text",
            label: "前述服務加強改善後，是否會提升您使用兩鐵列車的意願？",
            required: true,
            options: [
              {
                value: "是",
                label: "是",
              },
              {
                value: "不一定",
                label: "不一定",
              },
              {
                value: "否",
                label: "否",
                hasTextInput: true,
                textLabel: "請說明原因",
                textPlaceholder: "請簡單說明原因...",
                textMinLength: 5,
                textMaxLength: 300,
              },
            ],
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
          {
            id: "train-station-friendliness",
            type: "textarea",
            label:
              "有愈來愈多的青年學子及多元弱勢族群（如：高齡者、身心障礙人士）以騎乘自行車環島當作人生挑戰，您認為做為自行車補給站的臺鐵車站有哪些可再增加或提升的自行車友善設施？",
            required: true,
            conditional: {
              dependsOn: "train-used",
              showWhen: "是",
            },
          },
        ],
      }
    ],
  },
  
  ]
}

// Dynamic questionnaire getter
export function getDefaultQuestionnaires(): Questionnaire[] {
  return generateDefaultQuestionnaires()
}

// Export the constant for backward compatibility  
export const DEFAULT_QUESTIONNAIRES = generateDefaultQuestionnaires()

// Simple local questionnaire functions - no Firebase dependency
export function getQuestionnaires(): Questionnaire[] {
  return DEFAULT_QUESTIONNAIRES
}

export function getQuestionnaireById(id: string): Questionnaire | null {
  return getQuestionnaireFromRegistry(id) ?? null
}

export async function saveQuestionnaireResponse(response: Omit<QuestionnaireResponse, 'id' | 'submittedAt'>): Promise<string> {
  try {
    return await saveQuestionnaireResponseToFirebase(response)
  } catch (error) {
    console.error('Error saving questionnaire response to Firebase:', error)
    throw error
  }
}

export async function getQuestionnaireResponses(): Promise<QuestionnaireResponse[]> {
  try {
    return await getQuestionnaireResponsesFromFirebase()
  } catch (error) {
    console.error('Error fetching questionnaire responses from Firebase:', error)
    return []
  }
}

export async function getResponsesByQuestionnaireId(questionnaireId: string): Promise<QuestionnaireResponse[]> {
  try {
    return await getResponsesByQuestionnaireIdFromFirebase(questionnaireId)
  } catch (error) {
    console.error('Error fetching responses by questionnaire ID from Firebase:', error)
    return []
  }
}

export function validateQuestionnaireJSON(json: string): {
  valid: boolean
  error?: string
  questionnaire?: Questionnaire
} {
  try {
    const parsed = JSON.parse(json)

    if (!parsed.id || !parsed.title || !Array.isArray(parsed.sections)) {
      return { valid: false, error: "缺少必要欄位：id / title / sections" }
    }

    for (const section of parsed.sections) {
      if (!section.id || !section.title || !Array.isArray(section.questions)) {
        return { valid: false, error: "Section 結構不正確" }
      }
      for (const q of section.questions) {
        if (!q.id || !q.type || !q.label) {
          return { valid: false, error: "Question 結構不正確" }
        }
      }
    }

    return { valid: true, questionnaire: parsed }
  } catch {
    return { valid: false, error: "JSON 格式錯誤" }
  }
}
